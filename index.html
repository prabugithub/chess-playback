<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Playback Viewer</title>
    <style>
        /* Mobile-first base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 12px;
        }

        .container {
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 24px;
            font-weight: bold;
        }

        .board-container {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .chess-board {
            display: inline-block;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .board-row {
            display: flex;
        }

        .square {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: background-color 0.3s;
            position: relative;
        }

        .coordinate {
            position: absolute;
            font-size: 9px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .square.light .coordinate {
            color: rgba(139, 69, 19, 0.6);
        }

        .square.dark .coordinate {
            color: rgba(245, 222, 179, 0.7);
        }

        .file-label {
            bottom: 2px;
            right: 3px;
        }

        .rank-label {
            top: 2px;
            left: 3px;
        }

        .square.light { background-color: #f0d9b5; }
        .square.dark { background-color: #b58863; }
        .square.highlight { background-color: #ffd93d; }

        .current-move {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 16px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            color: #333;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        button {
            padding: 10px 14px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 80px;
            justify-content: center;
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc !important;
            cursor: not-allowed;
        }

        .btn-primary { background: #667eea; }
        .btn-success { background: #10b981; }
        .btn-warning { background: #f59e0b; }
        .btn-danger { background: #ef4444; }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f5f5f5;
            padding: 10px 16px;
            border-radius: 6px;
            width: 100%;
            justify-content: center;
        }

        .speed-control span {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
        }

        .speed-control button {
            flex: 0 0 auto;
            min-width: 40px;
            padding: 8px 12px;
        }

        .progress-container {
            width: 100%;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 6px;
            color: #666;
            font-size: 12px;
        }

        .move-list {
            margin-top: 16px;
            max-height: 180px;
            overflow-y: auto;
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .move-list h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .move-item {
            display: grid;
            grid-template-columns: 35px 1fr 1fr;
            gap: 6px;
            padding: 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .move-item.active {
            background: #e0e7ff;
        }

        .move-number {
            font-weight: bold;
            color: #667eea;
        }

        .move-notation {
            cursor: pointer;
            color: #333;
            word-break: break-word;
        }

        .move-notation:hover {
            color: #667eea;
        }

        .move-notation.active {
            color: #667eea;
            font-weight: bold;
        }

        .upload-section {
            margin-bottom: 16px;
            padding: 16px;
            background: #f0f9ff;
            border-radius: 6px;
            border: 2px dashed #667eea;
        }

        .upload-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .file-input {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 13px;
        }

        .share-section {
            margin-top: 16px;
            padding: 16px;
            background: #f0fdf4;
            border-radius: 6px;
            border: 2px solid #10b981;
        }

        .share-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .share-section .button-group {
            gap: 8px;
        }

        .share-section button {
            flex: 1;
            min-width: 100px;
        }

        .share-link {
            width: 100%;
            padding: 10px;
            border: 2px solid #10b981;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 10px;
            font-family: monospace;
            word-break: break-all;
        }

        .json-editor {
            margin-top: 10px;
        }

        .json-editor textarea {
            width: 100%;
            min-height: 180px;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
        }

        .tab-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 8px 12px;
            background: #e5e7eb;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 13px;
            flex: 1;
            min-width: 80px;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tablet styles (min-width: 640px) */
        @media (min-width: 640px) {
            body {
                padding: 20px;
            }

            .container {
                border-radius: 16px;
                padding: 24px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }

            h1 {
                font-size: 28px;
                margin-bottom: 20px;
            }

            .square {
                width: 50px;
                height: 50px;
                font-size: 36px;
            }

            .coordinate {
                font-size: 10px;
            }

            .chess-board {
                border: 3px solid #333;
                border-radius: 6px;
            }

            .current-move {
                font-size: 18px;
                padding: 12px;
                margin-bottom: 20px;
            }

            button {
                padding: 11px 18px;
                font-size: 15px;
                gap: 7px;
                flex: initial;
            }

            .speed-control {
                padding: 12px 18px;
                gap: 10px;
            }

            .speed-control span {
                min-width: 80px;
                font-size: 15px;
            }

            .progress-bar {
                height: 7px;
            }

            .progress-text {
                font-size: 13px;
            }

            .move-list {
                max-height: 200px;
                padding: 14px;
            }

            .move-item {
                grid-template-columns: 38px 1fr 1fr;
                font-size: 14px;
                padding: 7px;
            }

            .tab-button {
                padding: 9px 14px;
                font-size: 14px;
                flex: initial;
            }

            .share-section button {
                flex: initial;
            }
        }

        /* Desktop styles (min-width: 768px) */
        @media (min-width: 768px) {
            .container {
                max-width: 900px;
            }

            h1 {
                font-size: 32px;
                margin-bottom: 24px;
            }

            .square {
                width: 60px;
                height: 60px;
                font-size: 40px;
            }

            .coordinate {
                font-size: 11px;
            }

            .chess-board {
                border-radius: 8px;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            }

            .board-container {
                margin-bottom: 24px;
            }

            .current-move {
                font-size: 20px;
            }

            .controls {
                gap: 16px;
                margin-bottom: 24px;
            }

            .button-group {
                gap: 12px;
            }

            button {
                padding: 12px 20px;
                font-size: 16px;
                gap: 8px;
            }

            .speed-control {
                padding: 12px 20px;
                gap: 12px;
            }

            .speed-control span {
                min-width: 100px;
                font-size: 16px;
            }

            .progress-bar {
                height: 8px;
            }

            .progress-text {
                margin-top: 8px;
                font-size: 14px;
            }

            .move-list {
                margin-top: 24px;
                padding: 16px;
                border-radius: 8px;
            }

            .move-list h3 {
                font-size: 18px;
                margin-bottom: 12px;
            }

            .move-item {
                grid-template-columns: 40px 1fr 1fr;
                gap: 8px;
                padding: 8px;
            }

            .upload-section,
            .share-section {
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 24px;
            }

            .upload-section h3,
            .share-section h3 {
                font-size: 18px;
                margin-bottom: 12px;
            }

            .file-input,
            .share-link {
                padding: 12px;
                font-size: 14px;
                border-radius: 8px;
                margin-bottom: 12px;
            }

            .json-editor {
                margin-top: 12px;
            }

            .json-editor textarea {
                min-height: 200px;
                padding: 12px;
                font-size: 12px;
                border-radius: 8px;
            }

            .tab-buttons {
                gap: 8px;
                margin-bottom: 16px;
            }

            .tab-button {
                padding: 10px 16px;
                font-size: 14px;
                border-radius: 8px;
            }
        }

        /* Large desktop styles (min-width: 1024px) */
        @media (min-width: 1024px) {
            button:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ôüÔ∏è Chess Playback Viewer</h1>

        <!-- Upload/Input Section -->
        <div class="upload-section">
            <h3>Load Game</h3>
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('upload')">Upload JSON</button>
                <button class="tab-button" onclick="switchTab('paste')">Paste JSON</button>
                <button class="tab-button" onclick="switchTab('create')">Create Moves</button>
                <button class="tab-button" onclick="switchTab('sample')">Load Sample</button>
            </div>

            <div id="upload-tab" class="tab-content active">
                <input type="file" id="fileInput" accept=".json" class="file-input">
                <button onclick="loadFromFile()" class="btn-primary">Load Game from File</button>
            </div>

            <div id="paste-tab" class="tab-content">
                <div class="json-editor">
                    <textarea id="jsonInput" placeholder='Paste your JSON here, e.g.:
{
  "game": [
    { "move": 1, "white": "e2-e4", "black": "e7-e5" },
    { "move": 2, "white": "Ng1-f3", "black": "Nb8-c6" }
  ]
}'></textarea>
                    <button onclick="loadFromJSON()" class="btn-primary" style="margin-top: 12px;">Load Game from JSON</button>
                </div>
            </div>

            <div id="create-tab" class="tab-content">
                <p style="margin-bottom: 12px; color: #666; font-size: 14px; line-height: 1.5;">
                    Don't have a JSON file? Use our converter to create one from chess notation!
                </p>
                <button onclick="window.open('json-converter.html', '_blank')" class="btn-success" style="width: 100%;">
                    üìù Open Move Converter (New Tab)
                </button>
                <p style="margin-top: 12px; font-size: 13px; color: #666; line-height: 1.4;">
                    After creating your JSON, return here and use "Paste JSON" tab
                </p>
            </div>

            <div id="sample-tab" class="tab-content">
                <button onclick="loadSampleGame()" class="btn-success">Load Sample Game</button>
            </div>
        </div>

        <!-- Board Container -->
        <div class="board-container">
            <div class="chess-board" id="chessBoard"></div>
        </div>

        <!-- Current Move Display -->
        <div class="current-move" id="currentMove">Start Position</div>

        <!-- Controls -->
        <div class="controls">
            <!-- Playback Controls -->
            <div class="button-group">
                <button onclick="goToStart()" class="btn-primary">‚èÆÔ∏è Start</button>
                <button onclick="previousMove()" id="prevBtn" class="btn-primary">‚óÄÔ∏è Previous</button>
                <button onclick="togglePlay()" id="playBtn" class="btn-success">‚ñ∂Ô∏è Play</button>
                <button onclick="nextMove()" id="nextBtn" class="btn-primary">Next ‚ñ∂Ô∏è</button>
                <button onclick="goToEnd()" class="btn-primary">End ‚è≠Ô∏è</button>
            </div>

            <!-- Speed Controls -->
            <div class="speed-control">
                <span style="font-weight: 600; color: #333;">Speed:</span>
                <button onclick="decreaseSpeed()" class="btn-danger">‚àí</button>
                <span id="speedDisplay">1.0x</span>
                <button onclick="increaseSpeed()" class="btn-success">+</button>
            </div>

            <!-- Progress -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Move 0 of 0</div>
            </div>
        </div>

        <!-- Move List -->
        <div class="move-list" id="moveList">
            <h3>Move List:</h3>
            <div id="moveListContent"></div>
        </div>

        <!-- Share Section -->
        <div class="share-section">
            <h3>üîó Share This Game</h3>
            <input type="text" id="shareLink" class="share-link" readonly placeholder="Generate a shareable link...">
            <div class="button-group">
                <button onclick="generateShareLink()" class="btn-success">Generate Share Link</button>
                <button onclick="generateShortLink()" class="btn-warning" id="shortLinkBtn">‚úÇÔ∏è Create Short Link</button>
                <button onclick="copyShareLink()" class="btn-primary">üìã Copy Link</button>
            </div>
            <p id="shortLinkStatus" style="margin-top: 8px; font-size: 12px; color: #666; display: none;"></p>
        </div>
    </div>

    <script>
        // Game state
        let gameData = null;
        let currentBoard = [];
        let currentMoveIndex = -1;
        let isPlaying = false;
        let speed = 1000;
        let playInterval = null;
        let lastMove = null;

        // Initial board setup
        const initialBoard = [
            ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],
            ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
            ['.', '.', '.', '.', '.', '.', '.', '.'],
            ['.', '.', '.', '.', '.', '.', '.', '.'],
            ['.', '.', '.', '.', '.', '.', '.', '.'],
            ['.', '.', '.', '.', '.', '.', '.', '.'],
            ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
            ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
        ];

        const pieceSymbols = {
            'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô',
            'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü'
        };

        // Sample game data
        const sampleGame = {
            "game": [
                { "move": 1, "white": "d2-d4", "black": "d7-d5" },
                { "move": 2, "white": "c2-c4", "black": "e7-e5" },
                { "move": 3, "white": "Ng1-f3", "black": "e5xd4" },
                { "move": 4, "white": "Qd1xd4", "black": "d5xc4" },
                { "move": 5, "white": "Qd4xc4", "black": "Nb8-c6" },
                { "move": 6, "white": "e2-e3", "black": "Ng8-f6" },
                { "move": 7, "white": "Qc4-a4", "black": "Bc8-d7" },
                { "move": 8, "white": "Nb1-c3", "black": "Bf8-c5" },
                { "move": 9, "white": "Qa4-c2", "black": "O-O" },
                { "move": 10, "white": "Bf1-d3", "black": "Nc6-b4" },
                { "move": 11, "white": "Qc2-e2", "black": "Nb4xd3+" },
                { "move": 12, "white": "Qe2xd3", "black": "Bd7-g4" },
                { "move": 13, "white": "Qd3xd8", "black": "Ra8xd8" },
                { "move": 14, "white": "Nf3-e5", "black": "Bg4-f5" },
                { "move": 15, "white": "O-O", "black": "Rf8-e8" },
                { "move": 16, "white": "Ne5-f3", "black": "Bf5-g4" },
                { "move": 17, "white": "Nf3-e1", "black": "Nf6-e4" },
                { "move": 18, "white": "h2-h3", "black": "Ne4xc3" },
                { "move": 19, "white": "b2xc3", "black": "Bg4-e2" },
                { "move": 20, "white": "Ne1-d3", "black": "Rd8xd3" },
                { "move": 21, "white": "Rf1-e1", "black": "Be2-h5" },
                { "move": 22, "white": "Bc1-b2", "black": "Re8-e6" },
                { "move": 23, "white": "a2-a4", "black": "Re6-b6" },
                { "move": 24, "white": "Bb2-a3", "black": "Rd3xc3" },
                { "move": 25, "white": "Ba3-b2", "black": "Rb6xb2" },
                { "move": 26, "white": "a4-a5", "black": "Rc3-c2" },
                { "move": 27, "white": "Ra1-c1", "black": "Rc2xf2" },
                { "move": 28, "white": "Kg1-h2", "black": "Rf2xg2+" },
                { "move": 29, "white": "Kh2-h1", "black": "Rg2-h2+" },
                { "move": 30, "white": "Kh1-g1", "black": "Rb2-g2+" },
                { "move": 31, "white": "Kg1-f1", "black": "Bh5-f3" },
                { "move": 32, "white": "Rc1xc5", "black": "Rh2-h1#" }
            ]
        };

        // Initialize
        function init() {
            currentBoard = initialBoard.map(row => [...row]);
            renderBoard();
            updateControls();

            // Check for shared game in URL
            loadFromURL();

            // Check for game from converter (localStorage)
            checkPendingGame();

            // Listen for messages from converter window
            window.addEventListener('message', (event) => {
                if (event.origin !== window.location.origin) return;

                if (event.data.type === 'LOAD_GAME' && event.data.gameData) {
                    loadGame(event.data.gameData);
                }
            });
        }

        // Check for pending game from converter
        function checkPendingGame() {
            const pendingGame = localStorage.getItem('pendingGame');
            if (pendingGame) {
                try {
                    const data = JSON.parse(pendingGame);
                    loadGame(data);
                    localStorage.removeItem('pendingGame');
                } catch (error) {
                    console.error('Error loading pending game:', error);
                }
            }
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }

        // Load game from file
        function loadFromFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a JSON file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    loadGame(data);
                } catch (error) {
                    alert('Error parsing JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Load game from JSON text
        function loadFromJSON() {
            const jsonInput = document.getElementById('jsonInput').value;
            
            if (!jsonInput.trim()) {
                alert('Please paste JSON data');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                loadGame(data);
            } catch (error) {
                alert('Error parsing JSON: ' + error.message);
            }
        }

        // Load sample game
        function loadSampleGame() {
            loadGame(sampleGame);
        }

        // Load game from URL parameters
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedGame = urlParams.get('game');
            
            if (encodedGame) {
                try {
                    const decodedGame = atob(encodedGame);
                    const data = JSON.parse(decodedGame);
                    loadGame(data);
                } catch (error) {
                    console.error('Error loading game from URL:', error);
                }
            } else {
                // Load sample game by default
                loadGame(sampleGame);
            }
        }

        // Load game data
        function loadGame(data) {
            if (!data.game || !Array.isArray(data.game)) {
                alert('Invalid game format. Expected { "game": [...] }');
                return;
            }

            gameData = data;
            currentMoveIndex = -1;
            currentBoard = initialBoard.map(row => [...row]);
            lastMove = null;
            
            if (isPlaying) {
                togglePlay();
            }

            renderBoard();
            renderMoveList();
            updateControls();
            updateDisplay();
        }

        // Convert notation to board indices
        function notationToIndex(notation) {
            const file = notation.charCodeAt(0) - 97;
            const rank = 8 - parseInt(notation[1]);
            return [rank, file];
        }

        // Apply move to board
        function applyMove(board, moveStr, isWhite) {
            const newBoard = board.map(row => [...row]);
            
            // Handle castling
            if (moveStr === 'O-O' || moveStr === '0-0') {
                const rank = isWhite ? 7 : 0;
                const king = isWhite ? 'K' : 'k';
                const rook = isWhite ? 'R' : 'r';
                newBoard[rank][4] = '.';
                newBoard[rank][7] = '.';
                newBoard[rank][6] = king;
                newBoard[rank][5] = rook;
                lastMove = { from: [rank, 4], to: [rank, 6] };
                return newBoard;
            }
            
            if (moveStr === 'O-O-O' || moveStr === '0-0-0') {
                const rank = isWhite ? 7 : 0;
                const king = isWhite ? 'K' : 'k';
                const rook = isWhite ? 'R' : 'r';
                newBoard[rank][4] = '.';
                newBoard[rank][0] = '.';
                newBoard[rank][2] = king;
                newBoard[rank][3] = rook;
                lastMove = { from: [rank, 4], to: [rank, 2] };
                return newBoard;
            }

            // Parse regular moves
            const parts = moveStr.replace(/[+#]/, '').split(/[-x]/);
            if (parts.length === 2) {
                const from = notationToIndex(parts[0].slice(-2));
                const to = notationToIndex(parts[1]);
                
                const piece = newBoard[from[0]][from[1]];
                newBoard[to[0]][to[1]] = piece;
                newBoard[from[0]][from[1]] = '.';
                
                lastMove = { from, to };
            }
            
            return newBoard;
        }

        // Navigate to specific move
        function goToMove(moveIndex) {
            if (!gameData || moveIndex < -1 || moveIndex >= gameData.game.length * 2) {
                return;
            }
            
            currentMoveIndex = moveIndex;
            currentBoard = initialBoard.map(row => [...row]);
            lastMove = null;
            
            for (let i = 0; i <= moveIndex; i++) {
                const moveNum = Math.floor(i / 2);
                const isWhite = i % 2 === 0;
                const moveStr = isWhite ? gameData.game[moveNum].white : gameData.game[moveNum].black;
                currentBoard = applyMove(currentBoard, moveStr, isWhite);
            }
            
            renderBoard();
            updateDisplay();
            updateControls();
        }

        // Render chess board
        function renderBoard() {
            const boardElement = document.getElementById('chessBoard');
            boardElement.innerHTML = '';

            const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
            const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];

            currentBoard.forEach((row, i) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'board-row';

                row.forEach((piece, j) => {
                    const squareDiv = document.createElement('div');
                    const isLight = (i + j) % 2 === 0;
                    const isHighlight = lastMove && (
                        (lastMove.from[0] === i && lastMove.from[1] === j) ||
                        (lastMove.to[0] === i && lastMove.to[1] === j)
                    );

                    squareDiv.className = `square ${isLight ? 'light' : 'dark'} ${isHighlight ? 'highlight' : ''}`;
                    squareDiv.textContent = piece !== '.' ? pieceSymbols[piece] : '';

                    // Add file label (a-h) on the bottom row
                    if (i === 7) {
                        const fileLabel = document.createElement('span');
                        fileLabel.className = 'coordinate file-label';
                        fileLabel.textContent = files[j];
                        squareDiv.appendChild(fileLabel);
                    }

                    // Add rank label (1-8) on the first column
                    if (j === 0) {
                        const rankLabel = document.createElement('span');
                        rankLabel.className = 'coordinate rank-label';
                        rankLabel.textContent = ranks[i];
                        squareDiv.appendChild(rankLabel);
                    }

                    rowDiv.appendChild(squareDiv);
                });

                boardElement.appendChild(rowDiv);
            });
        }

        // Render move list
        function renderMoveList() {
            if (!gameData) return;
            
            const moveListContent = document.getElementById('moveListContent');
            moveListContent.innerHTML = '';
            
            gameData.game.forEach((move, idx) => {
                const moveDiv = document.createElement('div');
                moveDiv.className = `move-item ${Math.floor(currentMoveIndex / 2) === idx ? 'active' : ''}`;
                
                const moveNumber = document.createElement('span');
                moveNumber.className = 'move-number';
                moveNumber.textContent = move.move + '.';
                
                const whiteMove = document.createElement('span');
                whiteMove.className = `move-notation ${currentMoveIndex === idx * 2 ? 'active' : ''}`;
                whiteMove.textContent = move.white;
                whiteMove.onclick = () => goToMove(idx * 2);
                
                const blackMove = document.createElement('span');
                blackMove.className = `move-notation ${currentMoveIndex === idx * 2 + 1 ? 'active' : ''}`;
                blackMove.textContent = move.black;
                blackMove.onclick = () => goToMove(idx * 2 + 1);
                
                moveDiv.appendChild(moveNumber);
                moveDiv.appendChild(whiteMove);
                moveDiv.appendChild(blackMove);
                moveListContent.appendChild(moveDiv);
            });
        }

        // Update display
        function updateDisplay() {
            if (!gameData) return;
            
            // Update current move
            const currentMoveEl = document.getElementById('currentMove');
            if (currentMoveIndex < 0) {
                currentMoveEl.textContent = 'Start Position';
            } else {
                const moveNum = Math.floor(currentMoveIndex / 2);
                const isWhite = currentMoveIndex % 2 === 0;
                const move = gameData.game[moveNum];
                currentMoveEl.textContent = `${move.move}. ${isWhite ? move.white : `...${move.black}`}`;
            }
            
            // Update progress bar
            const totalMoves = gameData.game.length * 2;
            const progress = ((currentMoveIndex + 1) / totalMoves) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `Move ${currentMoveIndex + 1} of ${totalMoves}`;
            
            // Update move list highlighting
            renderMoveList();
        }

        // Update controls
        function updateControls() {
            if (!gameData) {
                document.getElementById('prevBtn').disabled = true;
                document.getElementById('nextBtn').disabled = true;
                document.getElementById('playBtn').disabled = true;
                return;
            }
            
            document.getElementById('prevBtn').disabled = currentMoveIndex < 0;
            document.getElementById('nextBtn').disabled = currentMoveIndex >= gameData.game.length * 2 - 1;
            document.getElementById('playBtn').disabled = false;
        }

        // Navigation functions
        function goToStart() {
            if (isPlaying) togglePlay();
            goToMove(-1);
        }

        function previousMove() {
            if (isPlaying) togglePlay();
            goToMove(currentMoveIndex - 1);
        }

        function nextMove() {
            if (isPlaying) togglePlay();
            goToMove(currentMoveIndex + 1);
        }

        function goToEnd() {
            if (isPlaying) togglePlay();
            if (gameData) {
                goToMove(gameData.game.length * 2 - 1);
            }
        }

        // Play/Pause toggle
        function togglePlay() {
            if (!gameData) return;
            
            isPlaying = !isPlaying;
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                playBtn.innerHTML = '‚è∏Ô∏è Pause';
                playBtn.className = 'btn-warning';
                
                // If at end, restart from beginning
                if (currentMoveIndex >= gameData.game.length * 2 - 1) {
                    goToMove(-1);
                }
                
                playInterval = setInterval(() => {
                    if (currentMoveIndex < gameData.game.length * 2 - 1) {
                        goToMove(currentMoveIndex + 1);
                    } else {
                        togglePlay();
                    }
                }, speed);
            } else {
                playBtn.innerHTML = '‚ñ∂Ô∏è Play';
                playBtn.className = 'btn-success';
                clearInterval(playInterval);
            }
        }

        // Speed control
        function increaseSpeed() {
            speed = Math.max(speed - 250, 250);
            updateSpeedDisplay();
            if (isPlaying) {
                togglePlay();
                togglePlay();
            }
        }

        function decreaseSpeed() {
            speed = Math.min(speed + 250, 3000);
            updateSpeedDisplay();
            if (isPlaying) {
                togglePlay();
                togglePlay();
            }
        }

        function updateSpeedDisplay() {
            document.getElementById('speedDisplay').textContent = (1000 / speed).toFixed(1) + 'x';
        }

        // Share functionality
        function generateShareLink() {
            if (!gameData) {
                alert('Please load a game first');
                return;
            }
            
            const encodedGame = btoa(JSON.stringify(gameData));
            const shareLink = window.location.origin + window.location.pathname + '?game=' + encodedGame;
            document.getElementById('shareLink').value = shareLink;
        }

        function copyShareLink() {
            const shareLinkInput = document.getElementById('shareLink');

            if (!shareLinkInput.value) {
                alert('Please generate a share link first');
                return;
            }

            shareLinkInput.select();
            document.execCommand('copy');
            alert('Share link copied to clipboard!');
        }

        // Generate short link using TinyURL API
        async function generateShortLink() {
            const shareLinkInput = document.getElementById('shareLink');
            const statusEl = document.getElementById('shortLinkStatus');
            const shortLinkBtn = document.getElementById('shortLinkBtn');

            if (!shareLinkInput.value) {
                alert('Please generate a share link first');
                return;
            }

            // Check if already a short link
            if (shareLinkInput.value.includes('tinyurl.com') || shareLinkInput.value.length < 50) {
                statusEl.textContent = '‚úì This link is already short!';
                statusEl.style.color = '#10b981';
                statusEl.style.display = 'block';
                return;
            }

            try {
                // Show loading state
                shortLinkBtn.disabled = true;
                shortLinkBtn.textContent = '‚è≥ Creating...';
                statusEl.textContent = 'Creating short link...';
                statusEl.style.color = '#667eea';
                statusEl.style.display = 'block';

                // Call TinyURL API
                const longUrl = encodeURIComponent(shareLinkInput.value);
                const response = await fetch(`https://tinyurl.com/api-create.php?url=${longUrl}`);

                if (!response.ok) {
                    throw new Error('Failed to create short link');
                }

                const shortUrl = await response.text();

                // Update the input with short URL
                shareLinkInput.value = shortUrl;

                // Show success message
                statusEl.textContent = '‚úì Short link created! Much easier to share via WhatsApp.';
                statusEl.style.color = '#10b981';

                // Reset button
                shortLinkBtn.disabled = false;
                shortLinkBtn.textContent = '‚úÇÔ∏è Create Short Link';

            } catch (error) {
                console.error('Error creating short link:', error);
                statusEl.textContent = '‚ö†Ô∏è Failed to create short link. You can still use the long link.';
                statusEl.style.color = '#ef4444';

                // Reset button
                shortLinkBtn.disabled = false;
                shortLinkBtn.textContent = '‚úÇÔ∏è Create Short Link';
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
